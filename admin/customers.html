<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý khách hàng</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      color: white;
    }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
    }
    .add {background: #10b981;}
    .edit {background: #3b82f6;}
    .delete {background: #ef4444;}
    .form-popup {
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .actions {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <h2>Quản lý khách hàng</h2>
  <div style="text-align:right;margin-bottom:10px;">
    <button class="btn add" onclick="showForm()">+ Thêm khách hàng</button>
  </div>
  <table id="customerTable">
    <thead>
      <tr>
        <th>Mã KH</th>
        <th>Tên khách hàng</th>
        <th>Liên hệ</th>
        <th>Điện thoại</th>
        <th>Thành phố</th>
        <th>Quốc gia</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="form-popup" id="customerForm">
    <h3 id="formTitle">Thêm khách hàng</h3>
    <input type="hidden" id="customerNumber">
    <label>Tên khách hàng</label>
    <input type="text" id="customerName">
    <label>Người liên hệ</label>
    <input type="text" id="contactFirstName">
    <label>Họ liên hệ</label>
    <input type="text" id="contactLastName">
    <label>Điện thoại</label>
    <input type="text" id="phone">
    <label>Địa chỉ</label>
    <input type="text" id="addressLine1">
    <label>Thành phố</label>
    <input type="text" id="city">
    <label>Quốc gia</label>
    <input type="text" id="country">
    <div class="actions" style="margin-top:10px;">
      <button class="btn add" onclick="saveCustomer()">Lưu</button>
      <button class="btn delete" onclick="closeForm()">Hủy</button>
    </div>
  </div>

  <script src="../assets/js/api.js"></script>
  <script>
    const tbody = document.querySelector("#customerTable tbody");
    const form = document.getElementById("customerForm");
    const formTitle = document.getElementById("formTitle");

    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));
    if (!token || !user || (user.role !== "Admin" && user.role !== "Sales")) {
      alert("Chỉ nhân viên hoặc quản trị viên được truy cập");
      window.location.href = "../login.html";
    }

    async function loadCustomers() {
      try {
        const data = await apiRequest("/customers", "GET", null, true);
        tbody.innerHTML = "";
        data.forEach(c => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${c.customerNumber}</td>
            <td>${c.customerName}</td>
            <td>${c.contactFirstName} ${c.contactLastName}</td>
            <td>${c.phone}</td>
            <td>${c.city}</td>
            <td>${c.country}</td>
            <td>
              <button class="btn edit" onclick="editCustomer(${c.customerNumber})">Sửa</button>
              <button class="btn delete" onclick="deleteCustomer(${c.customerNumber})">Xóa</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert("Lỗi tải khách hàng: " + err.message);
      }
    }

    function showForm(edit = false) {
      form.style.display = "block";
      formTitle.textContent = edit ? "Chỉnh sửa khách hàng" : "Thêm khách hàng";
    }

    function closeForm() {
      form.reset();
      form.style.display = "none";
    }

    async function saveCustomer() {
      const data = {
        customerName: document.getElementById("customerName").value,
        contactFirstName: document.getElementById("contactFirstName").value,
        contactLastName: document.getElementById("contactLastName").value,
        phone: document.getElementById("phone").value,
        addressLine1: document.getElementById("addressLine1").value,
        city: document.getElementById("city").value,
        country: document.getElementById("country").value,
        salesRepEmployeeNumber: null,
        creditLimit: null
      };
      try {
        const id = document.getElementById("customerNumber").value;
        if (id) {
          await apiRequest(`/customers/${id}`, "PUT", data, true);
          alert("Cập nhật thành công!");
        } else {
          await apiRequest("/customers", "POST", data, true);
          alert("Thêm thành công!");
        }
        closeForm();
        loadCustomers();
      } catch (err) {
        alert("Lỗi lưu: " + err.message);
      }
    }

    async function editCustomer(id) {
      try {
        const c = await apiRequest(`/customers/${id}`, "GET", null, true);
        document.getElementById("customerNumber").value = c.customerNumber;
        document.getElementById("customerName").value = c.customerName;
        document.getElementById("contactFirstName").value = c.contactFirstName;
        document.getElementById("contactLastName").value = c.contactLastName;
        document.getElementById("phone").value = c.phone;
        document.getElementById("addressLine1").value = c.addressLine1;
        document.getElementById("city").value = c.city;
        document.getElementById("country").value = c.country;
        showForm(true);
      } catch (err) {
        alert("Lỗi tải dữ liệu: " + err.message);
      }
    }

    async function deleteCustomer(id) {
      if (!confirm("Xóa khách hàng này?")) return;
      try {
        await apiRequest(`/customers/${id}`, "DELETE", null, true);
        alert("Đã xóa khách hàng");
        loadCustomers();
      } catch (err) {
        alert("Lỗi xóa: " + err.message);
      }
    }

    loadCustomers();
  </script>
</body>
</html>
