<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý văn phòng chi nhánh</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      color: white;
    }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
    }
    .add {background: #10b981;}
    .edit {background: #3b82f6;}
    .form-popup {
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .actions {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <h2>Quản lý văn phòng chi nhánh</h2>
  <div style="text-align:right;margin-bottom:10px;">
    <button class="btn add" onclick="showForm()">+ Thêm chi nhánh</button>
  </div>
  <table id="officeTable">
    <thead>
      <tr>
        <th>Mã</th>
        <th>Thành phố</th>
        <th>Địa chỉ</th>
        <th>Quốc gia</th>
        <th>Điện thoại</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="form-popup" id="officeForm">
    <h3 id="formTitle">Thêm chi nhánh</h3>
    <input type="hidden" id="officeCode">
    <label>Thành phố</label>
    <input type="text" id="city">
    <label>Điện thoại</label>
    <input type="text" id="phone">
    <label>Địa chỉ</label>
    <input type="text" id="addressLine1">
    <label>Quốc gia</label>
    <input type="text" id="country">
    <div class="actions" style="margin-top:10px;">
      <button class="btn add" onclick="saveOffice()">Lưu</button>
      <button class="btn edit" onclick="closeForm()">Hủy</button>
    </div>
  </div>

  <script src="../assets/js/api.js"></script>
  <script>
    const tbody = document.querySelector("#officeTable tbody");
    const form = document.getElementById("officeForm");
    const formTitle = document.getElementById("formTitle");

    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));
    if (!token || !user || user.role !== "Admin") {
      alert("Chỉ quản trị viên được truy cập");
      window.location.href = "../login.html";
    }

    async function loadOffices() {
      try {
        const data = await apiRequest("/offices", "GET", null, true);
        tbody.innerHTML = "";
        data.forEach(o => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${o.officeCode}</td>
            <td>${o.city}</td>
            <td>${o.addressLine1}</td>
            <td>${o.country}</td>
            <td>${o.phone}</td>
            <td><button class="btn edit" onclick="editOffice('${o.officeCode}')">Sửa</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert("Lỗi tải chi nhánh: " + err.message);
      }
    }

    function showForm(edit = false) {
      form.style.display = "block";
      formTitle.textContent = edit ? "Chỉnh sửa chi nhánh" : "Thêm chi nhánh";
    }

    function closeForm() {
      form.reset();
      form.style.display = "none";
    }

    async function saveOffice() {
      const body = {
        officeCode: document.getElementById("officeCode").value || null,
        city: document.getElementById("city").value,
        phone: document.getElementById("phone").value,
        addressLine1: document.getElementById("addressLine1").value,
        country: document.getElementById("country").value
      };
      try {
        if (body.officeCode) {
          await apiRequest(`/offices/${body.officeCode}`, "PUT", body, true);
          alert("Cập nhật thành công!");
        } else {
          await apiRequest("/offices", "POST", body, true);
          alert("Thêm chi nhánh thành công!");
        }
        closeForm();
        loadOffices();
      } catch (err) {
        alert("Lỗi lưu: " + err.message);
      }
    }

    async function editOffice(code) {
      try {
        const o = await apiRequest(`/offices/${code}`, "GET", null, true);
        document.getElementById("officeCode").value = o.officeCode;
        document.getElementById("city").value = o.city;
        document.getElementById("phone").value = o.phone;
        document.getElementById("addressLine1").value = o.addressLine1;
        document.getElementById("country").value = o.country;
        showForm(true);
      } catch (err) {
        alert("Lỗi tải dữ liệu: " + err.message);
      }
    }

    loadOffices();
  </script>
</body>
</html>
