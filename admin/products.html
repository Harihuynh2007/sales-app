<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý sản phẩm</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      color: white;
    }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
    }
    .add {background: #10b981;}
    .edit {background: #3b82f6;}
    .delete {background: #ef4444;}
    .form-popup {
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .actions {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <h2>Quản lý sản phẩm</h2>
  <div style="text-align:right;margin-bottom:10px;">
    <button class="btn add" onclick="showForm()">+ Thêm sản phẩm</button>
  </div>
  <table id="productTable">
    <thead>
      <tr>
        <th>Mã</th>
        <th>Tên sản phẩm</th>
        <th>Danh mục</th>
        <th>Hãng</th>
        <th>Tồn kho</th>
        <th>Giá</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="form-popup" id="productForm">
    <h3 id="formTitle">Thêm sản phẩm</h3>
    <input type="hidden" id="productCode">
    <label>Tên sản phẩm</label>
    <input type="text" id="productName">
    <label>Danh mục</label>
    <input type="text" id="productLine">
    <label>Nhà cung cấp</label>
    <input type="text" id="productVendor">
    <label>Số lượng tồn</label>
    <input type="number" id="quantityInStock">
    <label>Giá bán (MSRP)</label>
    <input type="number" id="MSRP">
    <label>Mô tả</label>
    <textarea id="productDescription"></textarea>
    <div class="actions" style="margin-top:10px;">
      <button class="btn add" onclick="saveProduct()">Lưu</button>
      <button class="btn delete" onclick="closeForm()">Hủy</button>
    </div>
  </div>

  <script src="../assets/js/api.js"></script>
  <script>
    const tbody = document.querySelector("#productTable tbody");
    const form = document.getElementById("productForm");
    const formTitle = document.getElementById("formTitle");
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));
    if (!token || !user || (user.role !== "Admin" && user.role !== "Sales")) {
      alert("Chỉ nhân viên hoặc quản trị viên được truy cập");
      window.location.href = "../login.html";
    }

    async function loadProducts() {
      try {
        const data = await apiRequest("/products", "GET", null, true);
        tbody.innerHTML = "";
        data.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.productCode}</td>
            <td>${p.productName}</td>
            <td>${p.productLine}</td>
            <td>${p.productVendor}</td>
            <td>${p.quantityInStock}</td>
            <td>${p.MSRP.toLocaleString()}₫</td>
            <td>
              <button class="btn edit" onclick="editProduct('${p.productCode}')">Sửa</button>
              <button class="btn delete" onclick="deleteProduct('${p.productCode}')">Xóa</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert("Lỗi tải sản phẩm: " + err.message);
      }
    }

    function showForm(edit = false) {
      form.style.display = "block";
      formTitle.textContent = edit ? "Chỉnh sửa sản phẩm" : "Thêm sản phẩm";
    }

    function closeForm() {
      form.reset();
      form.style.display = "none";
    }

    async function saveProduct() {
      const data = {
        productCode: document.getElementById("productCode").value,
        productName: document.getElementById("productName").value,
        productLine: document.getElementById("productLine").value,
        productVendor: document.getElementById("productVendor").value,
        productDescription: document.getElementById("productDescription").value,
        quantityInStock: parseInt(document.getElementById("quantityInStock").value),
        buyPrice: 0,
        MSRP: parseFloat(document.getElementById("MSRP").value)
      };
      try {
        if (data.productCode) {
          await apiRequest(`/products/${data.productCode}`, "PUT", data, true);
          alert("Cập nhật thành công!");
        } else {
          data.productCode = "P" + Date.now();
          await apiRequest("/products", "POST", data, true);
          alert("Thêm thành công!");
        }
        closeForm();
        loadProducts();
      } catch (err) {
        alert("Lỗi lưu: " + err.message);
      }
    }

    async function editProduct(code) {
      try {
        const p = await apiRequest(`/products/${code}`, "GET", null, true);
        document.getElementById("productCode").value = p.productCode;
        document.getElementById("productName").value = p.productName;
        document.getElementById("productLine").value = p.productLine;
        document.getElementById("productVendor").value = p.productVendor;
        document.getElementById("productDescription").value = p.productDescription;
        document.getElementById("quantityInStock").value = p.quantityInStock;
        document.getElementById("MSRP").value = p.MSRP;
        showForm(true);
      } catch (err) {
        alert("Lỗi tải dữ liệu: " + err.message);
      }
    }

    async function deleteProduct(code) {
      if (!confirm("Xóa sản phẩm này?")) return;
      try {
        await apiRequest(`/products/${code}`, "DELETE", null, true);
        alert("Đã xóa sản phẩm");
        loadProducts();
      } catch (err) {
        alert("Lỗi xóa: " + err.message);
      }
    }

    loadProducts();
  </script>
</body>
</html>
