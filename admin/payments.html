<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý thanh toán</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      color: white;
    }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      color: white;
    }
    .add {background: #10b981;}
    .delete {background: #ef4444;}
    .form-popup {
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .actions {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <h2>Quản lý thanh toán</h2>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <div>
      <label>Tìm theo mã khách hàng: </label>
      <input type="number" id="filterCustomer" placeholder="Nhập mã KH" style="width:150px;">
      <button class="btn add" onclick="filterPayments()">Tìm</button>
    </div>
    <button class="btn add" onclick="showForm()">+ Thêm thanh toán</button>
  </div>

  <table id="paymentTable">
    <thead>
      <tr>
        <th>Mã KH</th>
        <th>Tên khách hàng</th>
        <th>Số check</th>
        <th>Ngày thanh toán</th>
        <th>Số tiền</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="form-popup" id="paymentForm">
    <h3>Thêm thanh toán</h3>
    <label>Mã khách hàng</label>
    <input type="number" id="customerNumber">
    <label>Số check</label>
    <input type="text" id="checkNumber">
    <label>Ngày thanh toán</label>
    <input type="date" id="paymentDate">
    <label>Số tiền</label>
    <input type="number" id="amount">
    <div class="actions" style="margin-top:10px;">
      <button class="btn add" onclick="savePayment()">Lưu</button>
      <button class="btn delete" onclick="closeForm()">Hủy</button>
    </div>
  </div>

  <script src="../assets/js/api.js"></script>
  <script>
    const tbody = document.querySelector("#paymentTable tbody");
    const form = document.getElementById("paymentForm");
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user"));
    if (!token || !user || (user.role !== "Admin" && user.role !== "Sales")) {
      alert("Chỉ nhân viên hoặc quản trị viên được truy cập");
      window.location.href = "../login.html";
    }

    async function loadPayments() {
      try {
        const data = await apiRequest("/payments", "GET", null, true);
        renderPayments(data);
      } catch (err) {
        alert("Lỗi tải thanh toán: " + err.message);
      }
    }

    async function filterPayments() {
      const customerId = document.getElementById("filterCustomer").value.trim();
      if (!customerId) return loadPayments();
      try {
        const data = await apiRequest(`/payments/customer/${customerId}`, "GET", null, true);
        renderPayments(data);
      } catch (err) {
        alert("Không tìm thấy dữ liệu: " + err.message);
      }
    }

    function renderPayments(list) {
      tbody.innerHTML = "";
      list.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.customerNumber}</td>
          <td>${p.customerName || ""}</td>
          <td>${p.checkNumber}</td>
          <td>${p.paymentDate}</td>
          <td>${p.amount.toLocaleString()}₫</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function showForm() {
      form.style.display = "block";
    }

    function closeForm() {
      form.reset();
      form.style.display = "none";
    }

    async function savePayment() {
      const body = {
        customerNumber: parseInt(document.getElementById("customerNumber").value),
        checkNumber: document.getElementById("checkNumber").value,
        paymentDate: document.getElementById("paymentDate").value,
        amount: parseFloat(document.getElementById("amount").value)
      };
      try {
        await apiRequest("/payments", "POST", body, true);
        alert("Thêm thanh toán thành công!");
        closeForm();
        loadPayments();
      } catch (err) {
        alert("Lỗi thêm thanh toán: " + err.message);
      }
    }

    loadPayments();
  </script>
</body>
</html>
